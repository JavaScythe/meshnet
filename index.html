<!DOCTYPE html>
<html>
	<head>
		<title>openFMN</title>
		<style>
			body{
				background-color: #000;
			}
			*{color:#fff;}
		</style>
	</head>
	<body>
		<pre id="logs">log top</pre>
		<script src="/peerjs.js"></script>
		<script>
			function log(m){
				document.getElementById("logs").textContent = document.getElementById("logs").textContent+"\n"+m;
				return m;
			}
			async function checkConn(conn){
				var con = false;
				conn.on('open', function() {
					con=true;
					conn.close();
				});
				await new Promise(resolve => setTimeout(resolve, 1000));
				return con;
			}
			async function onReady(id){
				log("readied peerjs with id "+id);
				var cb = "nullfound";
				for(var i = 0; i<=10; i++){
					//`openfnm-node${i}-x`
					//"603f7dde-1d37-425b-8f5c-0e2a081a5859"
					var conn = peer.connect(`openfnm-node${i}-x`);
					var w = await checkConn(conn);
					if(!w){
						log(`connection to node${i} failed`);
					} else {
						log(`connection to node${i} succeded`);
						cb=i;
						break;
					}
				}
				if(cb=="nullfound"){
					log("failed to find existing network, starting network");
					log("rewrite self with data found, init peerjs with specific id");
					window._openfmn = {
						"created": new Date().getTime(),
						"nodes": [
							{id: "0", join: new Date().getTime() }
						]
					}
					peer.destroy();
					peer = new Peer(`openfnm-node0-x`);
					peer.on('open', function(id) {
						log("registered as "+id+", defining join functions");
						participate(peer);
					});
				} else {
					var conn = peer.connect(`openfnm-node${cb}-x`);
					conn.on('open', function() {
						conn.send({
							"type": "join",
							"time": new Date().getTime()
						});
						conn.on("data", function(data){
							if(data.type == "jmap"){
								log("got network map to join");
								console.log(data.map);
								joinNetwork(data.map,cb);
							}
						});
					});
				}
			}
			function joinNetwork(map,entry){
				var cid = undefined;
				for(var i=0;i>-1;i++){
					var f = true
					for(var k in map.nodes){
						if(map.nodes[k]["id"] == i){
							f=false;
						}
					}
					if(f){
						cid = i;
						break;
					}
					if(i>500) {log("critical no id 500 && throw");throw "";};
				}
				log("register with id "+cid);
				var conn = peer.connect(`openfnm-node${entry}-x`);
				conn.on('open', function() {
					conn.send({
						"type": "register",
						"id": cid,
						"time": new Date().getTime()
					});
					conn.on("data", function(data){
						if(data.type == "welcome"){
							log("accepted into network with new network map: ");
							log(JSON.stringify(data));
							window._openfmn = data.jmap;
							peer.destroy();
							peer = new Peer(`openfnm-node${cid}-x`);
							participate(peer);
						}
					});
				});
			}
			function participate(peer){
				peer.on('connection', function(conn) {
					conn.on('data', function(data) {
						log('Received '+JSON.stringify(data));
						if(data.type == "join"){
							console.log("sent map to discovering peer");
							conn.send({
								type: "jmap",
								map: window._openfmn
							});
						}
						if(data.type == "register"){
							console.log("made discover to node (type:welcome)");
							window._openfmn["nodes"].push({
								id: data.id,
								time: new Date().getTime()
							});
							conn.send({
								type: "welcome",
								jmap: window._openfmn
							})
						}
					});
				});
			}
			try{
				log("started");
				var peer = new Peer();
				peer.on('open', function(id) {
					peer.on('open', function(id){
						log("re registered with id "+id);
					});
					log("fired onready event");
					onReady(id)
				});
			}catch(e){
				log(e);
			}
		</script>
	</body>
</html>